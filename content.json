[{"title":"æ–°å¹´å¯¹è‡ªå·±çš„ä¸€äº›æœŸå¾…","date":"2017-01-09T16:45:34.000Z","path":"2017/01/10/æ–°å¹´å¯¹è‡ªå·±çš„ä¸€äº›æœŸå¾…/","text":"é—²è¯ğŸ’å¤šè¯´ æœ€è¿‘å…¬å¸åšæ–°é¡¹ç›®ï¼Œå¿™èµ·æ¥å¾ˆå¤šäº‹ä¹Ÿå°±é¡¾ä¸ä¸Šäº†ã€‚ä»¥è‡³äºæ–°å¹´éƒ½å¿˜äº†ç»™è‡ªå·±åšä¸‹æ€»ç»“ï¼Œé¡ºä¾¿åœ¨2017ç»™è‡ªå·±åšäº›è§„åˆ’ã€‚ä¸ç„¶å†è¿™æ ·æ‡’æ•£ä¸‹å»ï¼Œä¸è¯´æ¢¦æƒ³ä»€ä¹ˆçš„é¥è¿œçš„ä¸œè¥¿ï¼Œæœ€åŸºæœ¬çš„æˆ¿å­è½¦å­éƒ½ä¸çŸ¥é“è¦åˆ°çŒ´å¹´é©¬æœˆäº†ã€‚ æ‰€ä»¥åœ¨æ­¤å¯¹è‡ªå·±çš„2017åšäº›è§„åˆ’ï¼Œå’Œè¦æ±‚ã€‚èƒ½ä¸èƒ½å®ç°æ˜¯ä¸€å›äº‹ï¼Œæ­£å„¿å…«ç»çš„å†™ç‚¹è¦æ±‚è¿˜æ˜¯åº”è¯¥çš„ã€‚ é‰´äºä»¥å¾€çš„ç»éªŒï¼Œå’Œè‡ªå·±æ‡’æ•£çš„ä¸ªæ€§ï¼Œå¤ªéš¾çš„è¦æ±‚è‚¯å®šæ˜¯è¾¾ä¸åˆ°çš„ã€‚æ‰€ä»¥åœ¨ è¿™å°±ç®€å•è¯´ä¸‹è‡ªå·±å¯¹ç”Ÿæ´»å’ŒæŠ€æœ¯ä¸Šçš„ä¸€äº›åŸºæœ¬è¦æ±‚ã€‚åœ¨æ­¤ç«‹ä¸ªflagï¼Œç„¶åä¼šçœ‹èµ·æ¥ä¼°è®¡ä¼šå¯¹å¤ªè¿‡æ‡’æ•£çš„è‡ªå·±æœ‰äº›è®¸çš„æƒ­æ„§ï¼Œæ¯•ç«Ÿæƒ­æ„§æ‰æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›å˜›ã€‚ æŠ€æœ¯è¦æ±‚ ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜æ€ä¹ˆèƒ½å¯¹è‡ªå·±çš„æŠ€æœ¯æ²¡æœ‰è¦æ±‚å‘¢ï¼Œä¸‹é¢æ˜¯æˆ‘åœ¨2017å¯¹è‡ªå·±çš„æŠ€æœ¯è¦æ±‚ï¼š javaè™šæ‹Ÿæœºçš„ææ¸…æ¥šï¼Œå¯¹javaçš„é«˜çº§ç‰¹æ€§è¦åšåˆ°ç”¨çš„ç†Ÿï¼Œæ‡‚åŸç† Androidæ–¹é¢æŠŠAndroid FrameWorkçš„æºç åŸºæœ¬æ’¸ä¸€éï¼Œåšåˆ°æ¯å‘¨ä¸€ç¯‡æŠ€æœ¯åšå®¢ï¼Œå“ªæ€•åªæ˜¯æ‘˜æŠ„æºç ï¼Œä¹Ÿè¦åšæŒè¿™ä¸ªä¹ æƒ¯ ç‹¬ç«‹å®Œæˆä¸€æ¬¾éŸ³ä¹APPï¼Œå› ä¸ºè‡ªå·±ä¸€ç›´å¯¹å®ç°ä¸€æ¬¾éŸ³ä¹appå¿µå¿µä¸å¿˜ é˜…è¯»å’Œåˆ†æè‡³å°‘ä¸‰ä¸ªä¸»æµçš„æ¡†æ¶ï¼šæ¯”å¦‚OkHttpï¼ŒGlideï¼ŒRetrofit å­¦ä¹ ä¸€äº›æœåŠ¡ç«¯çš„çŸ¥è¯†ï¼Œäº‰å–èƒ½å†™è‡ªå·±çš„éŸ³ä¹æ’­æ”¾å™¨æ¥å£ ###ç”Ÿæ´»è¦æ±‚ æœ€åŸºæœ¬çš„ï¼Œæ¯å¤©æœ‰ç‚¹è¿åŠ¨é‡ï¼Œèƒ½å¥å¥èº«ï¼ŒæŠŠèº«ä½“æå¥½ é™ªé™ªå¥³ç¥¨ï¼Œåšåšé¥­ å»æ—…æ¸¸ä¸€åˆ°ä¸¤æ¬¡","tags":[{"name":"æ¯’è¯","slug":"æ¯’è¯","permalink":"http://yoursite.com/tags/æ¯’è¯/"}]},{"title":"Handlerå†ä¸€æ¬¡å›é¡¾ï¼ˆäºŒï¼‰","date":"2016-12-19T09:38:49.000Z","path":"2016/12/19/Handlerå†ä¸€æ¬¡å›é¡¾ï¼ˆäºŒï¼‰/","text":"åœ¨Handlerå†ä¸€æ¬¡å›é¡¾é‡Œï¼Œæˆ‘ä¸»è¦è®²åˆ°äº†ä¸»çº¿ç¨‹åœ¨Looperçš„loopé‡Œå¾ªç¯è¯»å–æ¶ˆæ¯ï¼Œç„¶åå¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå¹¶æ²¡æœ‰è¯´æ˜è¿™ä¸ªæ¶ˆæ¯æ˜¯æ€æ ·å‘é€çš„ã€‚è¿™ä¸€ç¯‡æˆ‘å‡†å¤‡ç»§ç»­é¡ºç€çº¿ç¨‹æ‰§è¡Œçš„é¡ºåºæ¥ä¸€æ­¥æ­¥çœ‹ï¼Œæ€æ ·ä»å‘é€æ¶ˆæ¯åˆ°å¤„ç†ä¸€ä¸ªæ¶ˆæ¯ï¼Œä»¥åŠæ¶ˆæ¯ç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚ åœ¨æ¥ç€ä¸Šä¸€ç¯‡æ€è·¯å¾€ä¸‹èµ°ä¹‹å‰ï¼Œå…ˆè¯´ä¸€ç‚¹å…³äºè¿›ç¨‹å’ŒAPPçš„ä¸œè¥¿ã€‚å¤šè¿›ç¨‹çš„ä¸œè¥¿åœ¨æ­¤ä¸æ¶‰åŠï¼Œé»˜è®¤æˆ‘ä»¬çš„APPåªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œå½“ç‚¹å‡»APPå›¾æ ‡ï¼Œéœ€è¦å¯åŠ¨ä¸€ä¸ªAPPæ—¶ï¼Œç³»ç»Ÿä¸ºæˆ‘ä»¬ç”¨å­µåŒ–å‡ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç”¨æ¥æ‰§è¡Œè¿™ä¸ªAPPçš„ä»£ç ã€‚è¿™ä¸ªæ–°è¿›ç¨‹é‡Œé¢çš„æœ‰ä¸ªçº¿ç¨‹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„ä¸»çº¿ç¨‹ï¼ŒåŒæ—¶è¿™ä¸ªä¸»çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹çš„åŒºåˆ«å°±æ˜¯æœ‰ä¸€ä¸ªLooperå’ŒMessageQueueã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼šç‚¹å‡»APPå›¾æ ‡åç³»ç»Ÿä¸ºæˆ‘ä»¬åšçš„äº‹å°±æ˜¯å­µåŒ–å‡ºä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹é‡Œæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹é‡Œé¢æœ‰ä¸ªLooperï¼ŒMessageQueueï¼Œç„¶åè®©æ‰§è¡Œåˆ°Looperçš„loopå¾ªç¯é‡Œã€‚è¿™ä¸ªæ—¶å€™ä¸»çº¿ç¨‹å°±åœ¨è¿™ä¸ªloopé‡Œé¢è·‘å¾ªç¯ï¼Œæ¯æ¬¡å»å–æ¶ˆæ¯æ¥å¤„ç†äº†ã€‚ ç„¶åæˆ‘ä»¬å†æƒ³ä¸€ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶ä¸»çº¿ç¨‹éƒ½åœ¨è·‘åœˆåœˆäº†ï¼Œæˆ‘ä»¬æ€ä¹ˆè®©ä¸»çº¿ç¨‹å»æ˜¾ç¤ºç•Œé¢å‘¢ï¼ŒActivityåœ¨å“ªåˆ›å»ºå‘¢ï¼Œåˆæ˜¯å¦‚ä½•æ‰§è¡Œåˆ°Activityçš„ onCreate() æ–¹æ³•çš„å‘¢ï¼Ÿå…¶å®è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå¾ˆå¥½æƒ³åˆ°ï¼Œåªè¦ç»™ä¸»çº¿ç¨‹çš„MessageQueueå‘æ¶ˆæ¯ï¼Œå°±å¯ä»¥äº†ã€‚è€Œç³»ç»Ÿä¹Ÿæ­£æ˜¯è¿™æ ·åšçš„ï¼Œ onCreate() æ˜¯ç”±ç³»ç»Ÿç»™ä¸»çº¿ç¨‹å‘æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹çš„MessageQueueä¸­ï¼Œå½“loopå¾ªç¯å–åˆ°è¿™ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œå¤„ç†æ¶ˆæ¯ä¹Ÿå°±æ˜¯æ‰§è¡Œ onCreate() è‚šå­é‡Œçš„ä»£ç ã€‚ä»loopå¾ªç¯é‡Œé¢åˆ° onCreate() è‚šå­é‡Œé¢ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹è·Ÿä¸Šç¯‡è®²çš„æ‰§è¡ŒHandlerçš„ handleMesaage() æ–¹æ³•çš„æ˜¯ä¸€æ ·çš„ã€‚ ä»ä¸Šä¸€ç¯‡åˆ°ç°åœ¨ï¼ŒåŸºæœ¬ä¸ŠåŸºäºäº‹ä»¶çš„çº¿ç¨‹çš„çª—å£æœºåˆ¶çš„æ¨¡å‹å·²ç»è¯´æ¸…æ¥šäº†ã€‚åªå‰©ä¸‹å…·ä½“æ¯ä¸€éƒ¨åˆ†çš„ç»†èŠ‚äº†ï¼Œæ¯”å¦‚å…·ä½“æ€æ ·å‘æ¶ˆæ¯ï¼Œå‘åˆ°å“ªï¼Œå–æ¶ˆæ¯ï¼Œä»å“ªå–ï¼Œæ€æ ·å–ï¼Ÿé’ˆå¯¹è¿™äº›ç»†èŠ‚ï¼Œæˆ‘ä»¬å†æ ¹æ®æºç ï¼Œè¿›è¡Œç»†è‡´çš„è¯´æ˜ã€‚ å…ˆä¸æ€¥äºçœ‹æºç ï¼Œæˆ‘ä»¬å…ˆåšä¸€ä»¶äº‹ï¼Œå°±æ˜¯è‡ªå·±çŒœï¼Œå¿˜æ‰ä»¥å‰å¯¹Handlerçš„è®¤çŸ¥ã€‚çŒœGoogleæ˜¯æ€æ ·å®ç°çš„ã€‚å› ä¸ºè¿™æ ·æˆ‘ä»¬æ‰èƒ½äº†è§£googleè®¾è®¡è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ç©¶ç«Ÿæ˜¯æ€æ ·æƒ³çš„ï¼Œä»–çš„ä»£ç å¦™åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œç„¶åæ‰å¯¹æ•´ä¸ªçŸ¥è¯†ç‚¹æœ‰æ›´æ·±åˆ»çš„è®¤çŸ¥ã€‚å…ˆä¸è¦è§‰å¾—æˆ‘åœ¨çå‡ æŠŠæ‰¯ï¼Œæˆ‘çœŸçš„è§‰å¾—è¿™æ ·çš„ç†è§£æ‰æ˜¯é¡ºå…¶è‡ªç„¶çš„ï¼ŒçœŸæ­£å¼„æ‡‚äº†è¿™ä¸ªä¸œè¥¿ï¼Œè€Œä¸æ˜¯æ­»è®°ç¡¬èƒŒï¼Œå«ç³Šä¸æ¸…ã€‚ ç°åœ¨æˆ‘ä»¬æœ‰å››ä¸ªç±»ï¼ŒLooperï¼ŒHandlerï¼ŒMessageï¼ŒMessageQueueï¼šç›®å‰æ¥è¯´æˆ‘ä»¬ä»…çŸ¥é“çš„å†…å®¹å°±æ˜¯ä¸»çº¿ç¨‹è·‘åˆ°Looperçš„ loop() å¾ªç¯é‡Œé¢ï¼ŒHandler å‘é€æ¶ˆæ¯åˆ°MessgeQueueï¼ŒLooperçš„loopä¸­è¦ä»MessageQueueæ‹¿å‡ºæ¶ˆæ¯ï¼Œç„¶åæœ€ç»ˆåœ¨Handlerçš„handleMessageé‡Œå–å¤„ç†æ¶ˆæ¯ã€‚ åŸºäºä¸Šé¢çš„è®¤çŸ¥æˆ‘ä»¬å¦‚æœè®¾è®¡çš„è¯ï¼Œè‡³å°‘è¦Handleråœ¨è°ƒsendMessgeæ–¹æ³•çš„æ—¶å€™åº”è¯¥æ˜¯æ‹¿åˆ°äº†MessageQueueçš„å¼•ç”¨ï¼Œç„¶åLooperå–æ¶ˆæ¯çš„æ—¶å€™è‚¯å®šä¹Ÿè¦æœ‰MessageQueueçš„å¼•ç”¨ã€‚messageè¢«å–å‡ºæ¥çš„æ—¶å€™è°ƒè¦æ‰¾åˆ°handlerå¹¶è°ƒç”¨å®ƒçš„handleMessageæ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œmessageä¹Ÿåº”è¯¥æŒæœ‰Handlerçš„å¼•ç”¨ã€‚æœ‰äº†è¿™äº›è®¤çŸ¥ä»¥åå†å»çœ‹æºç å°±ç›¸å½“ç®€å•äº†ï¼Œç”šè‡³è¯´è‡ªå·±éƒ½èƒ½è®¾è®¡å‡ºç®€åŒ–ç‰ˆã€‚ä¸‹é¢é¡ºç€å‘æ¶ˆæ¯åˆ°MessageQueueï¼Œå†ä»MessageQueueé‡Œé¢å–æ¶ˆæ¯å»å¤„ç†çš„è¿‡ç¨‹æ’¸ä¸€éæºç ï¼š å…ˆä»newä¸€ä¸ªHandlerå¼€å§‹ï¼Œçœ‹Handlerçš„æ„é€ æ–¹æ³•ï¼š public Handler(Callback callback, boolean async) { if (FIND_POTENTIAL_LEAKS) { final Class&lt;? extends Handler&gt; klass = getClass(); if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp; (klass.getModifiers() &amp; Modifier.STATIC) == 0) { Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; + klass.getCanonicalName()); } } mLooper = Looper.myLooper(); if (mLooper == null) { throw new RuntimeException( &quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;); } mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async; } public Handler(Looper looper, Callback callback, boolean async) { mLooper = looper; mQueue = looper.mQueue; mCallback = callback; mAsynchronous = async; } åœ¨è¿™é‡Œæˆ‘åªç½—åˆ—äº†ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œå…¶ä»–çš„æ„é€ æ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è¦è°ƒåˆ°è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼ˆè¿™ç§å†™æ³•åœ¨Androidæºç é‡Œéšå¤„å¯è§ï¼ŒåŒ…æ‹¬æˆ‘ä»¬å‘é€sendMessageå’ŒpostMessageï¼Œæˆ–è€…å»¶æ—¶å‘é€æ¶ˆæ¯æœ€ç»ˆéƒ½æ˜¯è°ƒçš„åŒä¸€ä¸ªå‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼‰ã€‚ä»è¿™ä¸¤ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹å‡ºHandlerå‘é€æ¶ˆæ¯å¯¹MessageQueueçš„å¼•ç”¨æ—¶é€šè¿‡ï¼š mQueue = looper.mQueue; è¿™å°±è¯´æ˜å¯¹MessageQueueçš„æ‰€æœ‰å¼•ç”¨éƒ½åœ¨Looperä¸­çš„ï¼Œè€Œæ•´ä¸ªçº¿ç¨‹çš„MessageQueueå°±æ˜¯looper.mQueueã€‚è€ŒHandleræŒæœ‰çš„æ˜¯Looperçš„å¼•ç”¨ã€‚æ— è®ºæ˜¯æ·»åŠ æ¶ˆæ¯è¿˜æ˜¯æ‘˜å–æ¶ˆæ¯éƒ½æ˜¯æ‹¿çš„looper.mQueueæ¥æ“ä½œçš„ã€‚ç„¶åæˆ‘ä»¬å†å»çœ‹sendMessageæ—¶æ·»åŠ ä¸€æ¡æ¶ˆæ¯åˆ°looper.mQueueï¼š public boolean sendMessageAtTime(Message msg, long uptimeMillis) { MessageQueue queue = mQueue; if (queue == null) { RuntimeException e = new RuntimeException( this + &quot; sendMessageAtTime() called with no mQueue&quot;); Log.w(&quot;Looper&quot;, e.getMessage(), e); return false; } return enqueueMessage(queue, msg, uptimeMillis); } private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) { msg.target = this; if (mAsynchronous) { msg.setAsynchronous(true); } return queue.enqueueMessage(msg, uptimeMillis); } sendMessageå’ŒpostRunnableæœ‰å¥½å‡ ç§æ–¹æ³•ï¼Œæ¯”å¦‚ sendMessageDelayed(Message msg, long delayMillis) å’Œ postDelayed(Runnable r, long delayMillis) è¿˜æœ‰å¦å¤–å‡ ä¸ªï¼Œä»–ä»¬æœ€ç»ˆè°ƒçš„éƒ½æ˜¯ sendMessageAtTime(Message msg, long uptimeMillis) å…¶å®å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œéƒ½æ˜¯åœ¨æŸä¸ªæ—¶åˆ»å‘é€ä¸€ä¸ªmessageçš„æ–¹å¼æ¥å®ç°çš„ï¼Œå…¶ä¸­å»¶æ—¶ï¼š sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis); ç”±ä¸Šé¢çš„Handlerçš„enqueueMessageæ–¹æ³•å¯ä»¥çœ‹å‡ºï¼ŒHandlerå…¶å®åªæ˜¯ç®—å‡ºåœ¨ä»€ä¹ˆæ—¶å€™å‘é€æ¶ˆæ¯ï¼Œå¹¶æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ ç»™äº†messageQueueï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç­‰å¾…åˆ°é‚£ä¸ªæ—¶é—´å»å‘é€ï¼Œè€Œæ˜¯ç«‹å³äº¤ç»™äº†MessageQueueå»å¤„ç†ã€‚ç”±æ­¤ä¾¿çŸ¥é“MessageQueueé‡Œé¢è¦ä¹ˆåœ¨æ’å…¥æ¶ˆæ¯æ—¶æœ‰ä¸€ä¸ªç­‰å¾…è¿‡ç¨‹ï¼Œè¦ä¹ˆåœ¨æ‘˜å–æ¶ˆæ¯æ—¶æœ‰ä¸€ä¸ªç­‰å¾…è¿‡ç¨‹ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹æºç ï¼š boolean enqueueMessage(Message msg, long when) { if (msg.target == null) { throw new IllegalArgumentException(&quot;Message must have a target.&quot;); } if (msg.isInUse()) { throw new IllegalStateException(msg + &quot; This message is already in use.&quot;); } synchronized (this) { if (mQuitting) { IllegalStateException e = new IllegalStateException( msg.target + &quot; sending message to a Handler on a dead thread&quot;); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; } msg.markInUse(); msg.when = when; Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) { // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked; } else { // Inserted within the middle of the queue. Usually we don&apos;t have to wake // up the event queue unless there is a barrier at the head of the queue // and the message is the earliest asynchronous message in the queue. needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) { prev = p; p = p.next; if (p == null || when &lt; p.when) { break; } if (needWake &amp;&amp; p.isAsynchronous()) { needWake = false; } } msg.next = p; // invariant: p == prev.next prev.next = msg; } // We can assume mPtr != 0 because mQuitting is false. if (needWake) { nativeWake(mPtr); } } return true; } ä¸Šé¢çš„ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼š å› ä¸ºMessageQueueæ’å…¥æ“ä½œå¯èƒ½æ¥è‡ªä¸åŒçº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œæ’å…¥æ“ä½œæ—¶åŠ é”ï¼Œç„¶åä»è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¶ˆæ¯é˜Ÿåˆ—å®é™…ä¸Šæ˜¯é€šè¿‡é“¾è¡¨å®ç°çš„ï¼ŒmMessagesæ˜¯å½“å‰é“¾è¡¨çš„å¤´ï¼Œæ˜ç™½äº†è¿™äº›ä¹‹åï¼Œæ•´ä¸ªä»£ç ä¸»è¦å°±æ˜¯æ ¹æ®messageé‡Œé¢çš„æ—¶é—´ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨sendMessageAtTimeä¼ è¿›æ¥çš„é‚£ä¸ªæ—¶é—´ï¼‰æ¥åˆ¤æ–­å½“å‰å…¥é˜Ÿåˆ—çš„è¿™ä¸ªmessageåº”è¯¥æ’å…¥åˆ°é“¾è¡¨çš„å“ªä¸ªä½ç½®ï¼Œæ¥ä¿è¯æ•´ä¸ªé“¾è¡¨æ˜¯ä¸€ä¸ªæŒ‰æ—¶é—´å…ˆåæ’åºçš„é“¾è¡¨ã€‚ ç°åœ¨å·²ç»æ‰§è¡Œå®Œäº† enqueueMessage(Message msg, long when) çš„ä»£ç ï¼Œä¸‹ä¸€æ­¥åº”è¯¥æ˜¯æ‘˜å–æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†äº†ï¼Œä¸Šç¯‡è¯´è¿‡ï¼Œä¸»çº¿ç¨‹åœ¨loopé‡Œç»•åœˆï¼Œæ¯æ¬¡éƒ½å»æ‘˜å–ä¸€æ¡æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œæ‘˜å–æ¶ˆæ¯çš„ä»£ç ä¸Šä¸€ç¯‡å·²ç»è´´å‡ºï¼Œåœ¨loopé‡Œé¢ï¼š Message msg = queue.next(); // might block æ‘˜å–æ¶ˆæ¯çš„ä»£ç ç¨é•¿ï¼Œè€Œä¸”ä¹Ÿæœ‰ç‚¹ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºè¿™é‡Œé¢å…³ç³»åˆ°åŒæ­¥æ¶ˆæ¯å’Œå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¸åŒçš„é—®é¢˜ï¼Œéœ€è¦åšä¸€äº›é“ºå«æ‰èƒ½è®²çš„æ˜ç™½ã€‚ç°åœ¨æˆ‘ä»¬å…ˆæŒ‰è‡ªå·±çš„ç†è§£ç»§ç»­å¾€ä¸‹èµ°ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªé“¾è¡¨å®ç°çš„ï¼Œç„¶åæ—¶é—´å…ˆåé¡ºåºå·²ç»æ’å¥½äº†ï¼ŒæŒ‰æˆ‘ä»¬çš„ç†è§£åº”è¯¥å°±æ˜¯æ¯æ¬¡loopçš„è¿‡ç¨‹æ¥å–æ¶ˆæ¯ï¼Œæ‹¿ç³»ç»Ÿå½“å‰æ—¶é—´å’Œé“¾è¡¨å¤´éƒ¨çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´è¿›è¡Œå¯¹æ¯”ï¼Œåˆ°ç¬¬ä¸€æ¡æ‰§è¡Œæ—¶é—´å°±è®©å®ƒå»æ‰§è¡Œï¼Œæ—¶é—´ä¸åˆ°å°±è¿”å›ä¸€ä¸ªnullã€‚ å½“ç„¶è¿™åªæ˜¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œç³»ç»Ÿçš„å®ç°æ–¹å¼æ¯”è¿™è¦å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯ä¹Ÿå¤æ‚ä¸äº†å¤ªå¤šï¼Œä¸‹é¢æ¥çœ‹queue.next()è¦æ‰§è¡Œçš„ä»£ç ï¼› Message next() { // Return here if the message loop has already quit and been disposed. // This can happen if the application tries to restart a looper after quit // which is not supported. final long ptr = mPtr; if (ptr == 0) { return null; } int pendingIdleHandlerCount = -1; // -1 only during first iteration int nextPollTimeoutMillis = 0; for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } nativePollOnce(ptr, nextPollTimeoutMillis); synchronized (this) { // Try to retrieve the next message. Return if found. final long now = SystemClock.uptimeMillis(); Message prevMsg = null; Message msg = mMessages; if (msg != null &amp;&amp; msg.target == null) { // Stalled by a barrier. Find the next asynchronous message in the queue. do { prevMsg = msg; msg = msg.next; } while (msg != null &amp;&amp; !msg.isAsynchronous()); } if (msg != null) { if (now &lt; msg.when) { // Next message is not ready. Set a timeout to wake up when it is ready. nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); } else { // Got a message. mBlocked = false; if (prevMsg != null) { prevMsg.next = msg.next; } else { mMessages = msg.next; } msg.next = null; if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg); msg.markInUse(); return msg; } } else { // No more messages. nextPollTimeoutMillis = -1; } // Process the quit message now that all pending messages have been handled. if (mQuitting) { dispose(); return null; } // If first time idle, then get the number of idlers to run. // Idle handles only run if the queue is empty or if the first message // in the queue (possibly a barrier) is due to be handled in the future. if (pendingIdleHandlerCount &lt; 0 &amp;&amp; (mMessages == null || now &lt; mMessages.when)) { pendingIdleHandlerCount = mIdleHandlers.size(); } if (pendingIdleHandlerCount &lt;= 0) { // No idle handlers to run. Loop and wait some more. mBlocked = true; continue; } if (mPendingIdleHandlers == null) { mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)]; } mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers); } // Run the idle handlers. // We only ever reach this code block during the first iteration. for (int i = 0; i &lt; pendingIdleHandlerCount; i++) { final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false; try { keep = idler.queueIdle(); } catch (Throwable t) { Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t); } if (!keep) { synchronized (this) { mIdleHandlers.remove(idler); } } } // Reset the idle handler count to 0 so we do not run them again. pendingIdleHandlerCount = 0; // While calling an idle handler, a new message could have been delivered // so go back and look again for a pending message without waiting. nextPollTimeoutMillis = 0; } } å’Œæˆ‘ä»¬æƒ³çš„å¹¶ä¸ä¸€æ ·ï¼Œè¿™é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªæ­»å¾ªç¯æ¥æ‘˜å–ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè€Œæˆ‘ä»¬å†çœ‹ä¸‹loopé‡Œé¢å–ä¸‹ä¸€æ¡æ¶ˆæ¯çš„æ³¨é‡Šï¼š Message msg = queue.next(); // might block æœ‰å¯èƒ½é˜»å¡ï¼Ÿå¯¹ï¼Œå…¶å®loopæ—¶ä»MessgeQueueé‡Œæ‘˜å–ä¸‹ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹å¹¶ä¸æ˜¯ç›´æ¥è¿”å›çš„ï¼Œè€Œæ˜¯æœ‰å¯èƒ½åœ¨MessageQueue.next()é‡Œé¢é˜»å¡ä½çš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯çœ‹ä»£ç ï¼šnextPollTimeoutMillisè¿™ä¸ªå˜é‡å°±æ˜¯é€šè¿‡messgeä¸Šæºå¸¦çš„æ—¶é—´å‡å»å½“å‰æ—¶é—´ã€‚ç„¶åç”¨åˆ°è¿™ä¸ªæ—¶é—´çš„åªæœ‰ä¸€ä¸ªåœ°æ–¹ï¼š nativePollOnce(ptr, nextPollTimeoutMillis); è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šå°±æ˜¯å»è°ƒC++çš„ä»£ç ï¼Œè®©å½“å‰çº¿ç¨‹ç­‰å¾…ç®¡é“é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œä¼ è¿›å»çš„ä¹Ÿå°±æ˜¯é˜»å¡æ—¶é—´ã€‚ä»€ä¹ˆç®¡é“ä¹±ä¸ƒå…«ç³Ÿçš„ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œå°±æ˜¯è®©å½“å‰çº¿ç¨‹é˜»å¡ä½è¿™ä¹ˆé•¿æ—¶é—´ã€‚è‡³äºä¸ºä»€ä¹ˆæ˜¯é˜»å¡è€Œä¸æ˜¯è®©çº¿ç¨‹ç©ºè½¬ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šè€ƒè™‘åœ¨é‡Œé¢ï¼Œè®©æˆ‘è¿™æ ·çš„å°ç™½ä¸å¾—æ„Ÿå¹ä¸€å¥ï¼ŒGoogleçš„å·¥ç¨‹å¸ˆçœŸçš„6ã€‚åœ¨è¿™é‡Œè®²ä¸‹æˆ‘ä¸ªäººçš„ä¸€äº›ç†è§£ï¼š æˆ‘ä»¬å¯ä»¥ä»JVMå‡æƒ³æœ‰ä¸ªcpuå­˜åœ¨ï¼Œè¿™ä¸éš¾ç†è§£å§ï¼ŒJVMæœ¬æ¥å°±æ˜¯è™šæ‹Ÿæœºï¼Œç„¶åä¸»çº¿ç¨‹å¦‚æœä¸€ç›´ç©ºè½¬çš„è¯ï¼Œä¸ç®¡cpué‡‡ç”¨å“ªç§è°ƒåº¦ç­–ç•¥ï¼Œä¸»çº¿ç¨‹éƒ½æœ‰å¯èƒ½åœ¨è¿™ä¸€æ®µæ—¶é—´å¾—åˆ°cpuçš„ä½¿ç”¨æƒï¼Œè€Œå®ƒæ‰§è¡Œçš„ä»£ç ç«Ÿç„¶æ˜¯ç©ºè½¬ï¼Œè¿™æ˜¯æ²¡å¿…è¦çš„ï¼Œåæ­£å®ƒè¿™æ®µæ—¶é—´æ²¡æœ‰æ¶ˆæ¯ï¼Œä¸»çº¿ç¨‹å°±æ˜¯é€šè¿‡loopæ‘˜å–æ¶ˆæ¯æ‰æ‰§è¡Œçš„ï¼Œç¦»ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æ¶ˆæ¯æ—¢ç„¶è¿˜æœ‰æ—¶é—´ï¼Œé‚£å°±è®©çº¿ç¨‹åœ¨è¿™æ®µæ—¶é—´é˜»å¡äº†ä¹Ÿæ— å¦¨ã€‚ ç¬¬äºŒä¸ªå°±æ˜¯ä¸ºgcè€ƒè™‘äº†ã€‚Androidæœ€é‡è¦çš„å°±æ˜¯ç”¨æˆ·ä½“éªŒï¼Œå“åº”é€Ÿåº¦ï¼Œè€ŒJavaçš„gcåƒåœ¾å›æ”¶åˆšå¥½æ˜¯å’Œè¿™ä¸ªç›®æ ‡ç›¸æ‚–ï¼Œå› ä¸ºgcçš„æ—¶å€™è¦ï¼šstop the worldï¼Œå°±æ˜¯è¦æ‰€æœ‰çš„ä¸œè¥¿éƒ½åœä¸‹æ¥ï¼Œgcå®Œäº†ä½ ä»¬å†æ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªæ­£åœ¨æ‰“å­—å’ŒMMèŠå¤©çš„ç”¨æˆ·çªç„¶è¢«gcå¡äº†ä¸€ä¸‹ï¼Œä¼šä¸ä¼šè§‰å¾—å¾ˆä¸çˆ½ï¼ˆå½“ç„¶æ²¡é‚£ä¹ˆæ˜æ˜¾ï¼Œä½†æ˜¯è¿˜æ˜¯è‚¯å®šè¦è€ƒè™‘gcçš„æ—¶é—´çš„ï¼‰ã€‚è€Œè¿™ä¸ªä¸»çº¿ç¨‹é˜»å¡çš„æ—¶é—´æ—¢ä¸ä¼šå½±å“ç”¨æˆ·äº¤äº’ï¼Œå¹²å˜›ä¸ç”¨æ¥gcå‘¢ï¼Œè‡³äºå…¶ä»–çº¿ç¨‹ï¼Œåªè¦ä¸æ˜¯UIçº¿ç¨‹ï¼Œgcé˜»ç¢ä¸€ä¼šåˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶é—´ä¹Ÿå¯ä»¥ç»™gcæ¥è€ƒè™‘è¦ä¸è¦gcã€‚ åˆ°æ­¤æ‘˜å–æ¶ˆæ¯ä¹Ÿè®²çš„å·®ä¸å¤šäº†ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»è®²è¿‡äº†å¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œæ¶ˆæ¯æœºåˆ¶çš„åŸºæœ¬åŠŸèƒ½å·²ç»è®²å®Œäº†ã€‚ ###TODOï¼šä¸è¿‡æˆ‘è¿˜æ˜¯æœ‰æ‰€ä¿ç•™çš„ï¼Œå¯¹åŒæ­¥æ¶ˆæ¯å’Œå¼‚æ­¥æ¶ˆæ¯è¿™ä¸€å—è¿˜æ²¡è®²ï¼Œç„¶åå¯¹IdleHandlerè¿™ä¸€å—ä¹Ÿæ²¡æœ‰è®²ï¼Œè¿˜æœ‰å°±æ˜¯Looperä¸ºä»€ä¹ˆè¦ç”¨ThreadLocalè€Œä¸æ˜¯ç”¨synchronizedã€‚å› ä¸ºè¦æƒ³è®²æ˜ç™½è¿™äº›ï¼Œå¿…é¡»ä¸€å±‚ä¸€å±‚çš„å¾€ä¸‹èµ°ï¼Œå…ˆæœ‰ä¸€ä¸ªåŸºæœ¬çš„æ¡†æ¶ï¼Œç„¶åå†å»çœ‹åŒæ­¥æ¶ˆæ¯å’Œå¼‚æ­¥æ¶ˆæ¯å…¶å®ä¹Ÿå°±æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¶ˆæ¯ç±»å‹è€Œå·²ï¼Œç„¶åå†å–æ¶ˆæ¯çš„è¿‡ç¨‹æœ‰ä¸€ç‚¹ç‚¹åŒºåˆ«ï¼Œæœ‰ä¸€ä¸ªæ—¶é—´åˆ†å‰²æ çš„æ¦‚å¿µã€‚ä¸»è¦è¿˜æ˜¯ä¸ºäº†è®©UIæ›´æµç•…çš„æ˜¾ç¤ºçš„ï¼Œå¹³æ—¶å¼€å‘åŸºæœ¬ç”¨ä¸ç€ï¼Œåœ¨è¯»Viewç›¸å…³çš„æºç çš„æ—¶å€™ç»å¸¸ç¢°åˆ°ï¼Œå…ˆæœ‰ä¸ªè¿™ä¸ªå°è±¡ã€‚Looperç”¨ThreadLocalä¹Ÿæ˜¯åŸºäºè®©ä¸»çº¿ç¨‹åœ¨loopæ—¶ä¸å¿…å› å…¶ä»–çº¿ç¨‹é”ä½Looperè€Œç­‰å¾…ï¼ˆå¦‚æœç”¨synchronizedï¼Œå½“å…¶ä»–çº¿ç¨‹ç”¨sendMessageæ—¶è¦æ‹¿åˆ°ä»Handleråˆ°Looperå†åˆ°MessageQueueçš„å¼•ç”¨ï¼Œè¿™æ˜¯å°±è¦å¯¹Looperè¿›è¡ŒåŠ é”ã€‚ï¼‰ï¼ˆæœ¬ç¯‡å®Œï¼Œä¸‹ç¯‡å¾…ç»­ï¼‰","tags":[{"name":"Android","slug":"Android","permalink":"http://yoursite.com/tags/Android/"}]},{"title":"Handlerå†ä¸€æ¬¡å›é¡¾","date":"2016-12-17T11:19:57.000Z","path":"2016/12/17/Handlerå†ä¸€æ¬¡å›é¡¾/","text":"åªè¦æ˜¯åšè¿‡Androidå¼€å‘çš„ï¼Œæƒ³å¿…å¯¹Handleréƒ½ä¸é™Œç”Ÿã€‚åœ¨æˆ‘åˆšå·¥ä½œçš„æ—¶å€™å°±å»çœ‹è¿‡Handlerçš„æºç ï¼Œä½†å½“æ—¶å±€é™äºå¯¹å¤šçº¿ç¨‹çš„ç†è§£å¹¶æ²¡æœ‰é‚£ä¹ˆæ·±åˆ»ï¼Œæ‰€ä»¥å¯¹Handlerçš„ç†è§£ä¹Ÿå°±ä»…ä»…åœç•™åœ¨è¡¨é¢ã€‚ç°åœ¨æœ‰æ—¶é—´é‡çœ‹Handleræºç ï¼ŒçŒ›ç„¶å‘ç°ï¼šæˆ‘æ“¦ï¼ŒHandlerè¿™ä¹ˆç®€å•ï¼Œç«Ÿç„¶å¥½å¤šé¢è¯•éƒ½å»é—®ï¼Œå¥½å¤šäººéƒ½æ˜¯é©¬é©¬è™è™ï¼Œä¸€çŸ¥åŠè§£ã€‚æ‰€ä»¥æˆ‘æƒ³åœ¨è¿™ç¯‡åšå®¢é‡Œï¼ŒæŠŠHandlerå½»åº•è®²é€äº†ï¼Œä»¥åå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘å¯¹Handlerçš„ç†è§£äº†ã€‚ å…¶å®å¾ˆå¤šäººå¯¹Handlerçš„ä¸ç†è§£ï¼Œå…³é”®è¿˜åœ¨äºå¯¹çº¿ç¨‹çš„ä¸ç†è§£ï¼Œæ‰€ä»¥æˆ‘å†³å®šå…ˆç®€å•è¯´ä¸‹çº¿ç¨‹çš„ç›¸å…³çš„çŸ¥è¯†ã€‚æˆ‘åœ¨è¿™ä¹Ÿä¸èƒ½è·Ÿä½ èƒ¡è¯´ï¼Œåœ¨Javaé‡Œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹Javaæºç é‡Œçº¿ç¨‹ç±»çš„æ³¨é‡Šï¼š /** * A {@code Thread} is a concurrent unit of execution. It has its own call stack * for methods being invoked, their arguments and local variables. Each application * has at least one thread running when it is started, the main thread, in the main * {@link ThreadGroup}. The runtime keeps its own threads in the system thread * group. * * &lt;p&gt;There are two ways to execute code in a new thread. * You can either subclass {@code Thread} and overriding its {@link #run()} method, * or construct a new {@code Thread} and pass a {@link Runnable} to the constructor. * In either case, the {@link #start()} method must be called to actually execute * the new {@code Thread}. * * &lt;p&gt;Each {@code Thread} has an integer priority that affect how the thread is * scheduled by the OS. A new thread inherits the priority of its parent. * A thread&apos;s priority can be set using the {@link #setPriority(int)} method. */ æˆ‘åœ¨è¿™ä¹Ÿä¸é€è¡Œå»ç¿»è¯‘äº†ï¼Œè‹±è¯­èƒ½çœ‹æ‡‚çš„å°±çœ‹çœ‹ï¼ŒæŒ‰æˆ‘çš„ç†è§£å°±æ˜¯ï¼šçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæ‰§è¡Œåºï¼Œæœ‰è‡ªå·±çš„æ‰§è¡Œæ ˆã€‚å®Œäº†ï¼Œå°±è¿™ä¹ˆå¤šã€‚æˆ‘çŸ¥é“è¿™ä¹ˆè¯´å¯¹äºåˆå­¦è€…è€…æ¥è¯´ï¼Œè‚¯å®šä¼šåœ¨ä¸‹é¢éª‚äº†ï¼Œå¦ˆè›‹ï¼Œä»€ä¹ˆæ˜¯æ‰§è¡Œåºå•Šï¼Ÿå…ˆåˆ«æ€¥ï¼ŒæŠŠåˆ€æ”¾ä¸‹ï¼Œå’±æ…¢æ…¢è¯´ã€‚æˆ‘ä»¬å†™ä»£ç æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¸ªå¯¹è±¡ï¼Œä¸€å †ä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿ï¼Œè¦æ‰§è¡Œå‡ºä¸€ä¸ªç¡®å®šçš„ç»“æœï¼Œè‚¯å®šæ˜¯è¦ä¸€ä¸ªç¡®å®šçš„é¡ºåºã€‚åŒ…æ‹¬å¤šçº¿ç¨‹ï¼Œåªè¦é€»è¾‘ä¸Šæœ‰å…ˆåé¡ºåºçš„ä¿¡æ¯ï¼Œä¹Ÿä¸€å®šè¦ä¿è¯æŒ‰ç¡®å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚ ç°åœ¨æ¥æƒ³ä¸€ä¸‹æˆ‘ä»¬å¹³æ—¶å¬äº†å…«ç™¾éçš„å¤šçº¿ç¨‹å®ç°æ–¹å¼ï¼Œå®ç° Runnable æ¥å£ï¼Œæˆ–è€… new Thread() ï¼Œä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæˆ‘ä»¬ä¸è¦å¿˜äº†å»è°ƒå®ƒçš„ start() æ–¹æ³•ã€‚è¿™æ—¶æ‰çœŸæ­£çš„å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå»æ‰§è¡Œæˆ‘ä»¬å†™åœ¨ run() æ–¹æ³•é‡Œçš„ä»£ç ã€‚å…¶å®ä»Android APPå¼€å‘è€…çš„è§’åº¦æ¥è®²ï¼ŒThreadçš„ run()å°±ç›¸å½“äºJavaæ¡†æ¶ç»™æˆ‘ä»¬çš„ä¸€ä¸ªæ‰§è¡Œä»£ç çš„å…¥å£ï¼Œè®©CPUæ¥æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼ˆè¿™ä¹ˆè¯´å½“ç„¶æ˜¯æ‰¯æ·¡ï¼Œä½†æ˜¯ä½ ä»…ä»APPå¼€å‘è€…æ•²ä»£ç çš„è§’åº¦å»çœ‹ï¼ŒæŠŠç¼–è¯‘ï¼Œé“¾æ¥ï¼Œè™šæ‹Ÿæœºï¼Œæ“ä½œç³»ç»Ÿå…¨çœ‹æˆé€æ˜çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¹ˆä¸ªç†ï¼‰ã€‚ æˆ‘ä»¬åªè¦å†™å¥½è‡ªå·±çš„ä»£ç ï¼Œä»£ç æ”¾è¿›å» run() çš„è‚šå­é‡Œï¼Œç„¶åæŒ‰ä¸‹å¼€å…³(æ‰§è¡Œ start() æ–¹æ³•)ï¼Œä»–å°±ä¸€ç›´æŒ‰æˆ‘ä»¬å†™å¥½çš„é¡ºåºè°ƒä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰ä»£ç æ‰§è¡Œç»“æŸã€‚å¿…é¡»æ˜ç™½çš„ä¸€ç‚¹æ˜¯çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæ‰§è¡Œåºï¼Œåœ¨Javaé‡Œï¼Œä»–æ˜¯ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œçš„ä»£ç è¦æ”¾åˆ°ä»–çš„ run() çš„è‚šå­é‡Œé¢ã€‚ç„¶åè°ƒ start() å‘Šè¯‰ Javaè™šæ‹Ÿæœºï¼Œç»™æˆ‘å¼€ä¸€çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒï¼Œå¼€å¯åæ¥æ‰§è¡Œæˆ‘å†™åœ¨ run() é‡Œçš„ä»£ç ã€‚ æœ‰äº†è¿™ä¸ªè®¤çŸ¥ä»¥åæˆ‘ä»¬å†æ¥çœ‹Threadçš„æºç ï¼š public class Thread implements Runnable è¿™é‡Œçœ‹åˆ°çš„æ˜¯Threadå®ç°äº†Runnableæ¥å£ï¼Œæ¥ç€çœ‹ä¸‹Runnableæ¥å£é‡Œé¢éƒ½å®šäº†å“ªäº›æŠ½è±¡æ–¹æ³•ï¼š public interface Runnable { /** * Starts executing the active part of the class&apos; code. This method is * called when a thread is started that has been created with a class which * implements {@code Runnable}. */ public void run(); } æ•´ä¸ªRunnableæ¥å£å°±è¿™ä¹ˆå¯æ€œçš„ä¸€ä¸ª run() æ–¹æ³•ã€‚ç»§ç»­çœ‹Threadæ€ä¹ˆå®ç°çš„ run() æ–¹æ³•ã€‚ Runnable target; public void run() { if (target != null) { target.run(); } } è¿™é‡Œå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹å‡ºæ¥ï¼Œæ— è®ºæ˜¯æˆ‘ä»¬ç»§æ‰¿Runnableæ¥å£ï¼Œè¿˜æ˜¯ç›´æ¥new Threadå®é™…ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚éƒ½æ˜¯æœ€ç»ˆè¦æŠŠéœ€è¦æ‰§è¡Œçš„ä»£ç æ”¾åˆ° Thread run() çš„è‚šå­é‡Œã€‚ç„¶åè°ƒ start() æ–¹æ³• public synchronized void start() { checkNotStarted(); hasBeenStarted = true; nativeCreate(this, stackSize, daemon); } start()è¿™é‡Œå°±å¾ˆæ˜¾äº† nativeCreate() çœ‹åå­—å°±çŸ¥é“æ˜¯è°ƒç”¨Cæˆ–C++å»åˆ›å»ºä¸€ä¸ªçº¿ç¨‹äº†ï¼Œè€Œåˆ›å»ºçº¿ç¨‹ä»¥åå‘¢ï¼Œè‡ªç„¶å»è°ƒ run() æ–¹æ³•è‚šå­é‡Œæˆ‘ä»¬å†™çš„ä»£ç æ¥æ‰§è¡Œäº†ã€‚ è¿™æ—¶æˆ‘ä»¬å·²ç»ç†è§£äº†æˆ‘ä»¬Javaå±‚çº¿ç¨‹çš„æ„ä¹‰ã€‚è‡³äºä»€ä¹ˆå»stopçº¿ç¨‹å•¦ï¼Œè®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œè®©çº¿ç¨‹å»sleepå•¦ï¼Œå’Œstartï¼ˆï¼‰åŸºæœ¬ä¸€æ ·çš„ï¼Œæ˜¯äº¤ç»™Javaæ¡†æ¶ï¼ˆè¿™é‡Œæ¡†æ¶è¿™ä¸ªè¯å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œå®¹æ˜“è¯¯è§£ä¸ºJ2EEçš„æ¡†æ¶ã€‚å…¶å®è¿™æ ·è¯´æ˜¯ç›¸å½“äºæŠŠJDKå½“ä½œä¸€ç§æ¡†æ¶æ¥çœ‹ï¼Œå°±åƒAndroidé‡Œç”¨çš„FrameWorkæ¡†æ¶ã€‚ï¼‰æ¥å¤„ç†çš„ã€‚ä¸æ˜¯æˆ‘ä»¬è°ƒäº†è¿™ä¸ªæ–¹æ³•å°±æ‰§è¡Œçš„ï¼Œè€Œæ˜¯æˆ‘ä»¬åªèƒ½é€šè¿‡æ¡†æ¶ç»™æˆ‘ä»¬å†™å¥½çš„ï¼Œæš´éœ²å‡ºæ¥çš„æ¥å£ï¼Œå»è·Ÿæ¡†æ¶äº¤äº’ï¼Œè‡³äºå®ƒèƒŒåæ˜¯åŒæ­¥ï¼Œå¼‚æ­¥ï¼Œæˆ–è€…ç­‰ä¸¤ç§’ï¼Œæˆ–è€…æ€æ ·æï¼Œè¿™äº›åªæ˜¯çº¿ç¨‹å…·ä½“å®ç°ä¸Šçš„äº‹ï¼Œè·Ÿæˆ‘ä»¬ç†è§£è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªæ‰§è¡Œåºæ²¡æœ‰ä¸€æ¯›é’±çš„å…³ç³»ã€‚å¦‚æœæƒ³å¯¹çº¿ç¨‹æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼Œç†è§£çº¿ç¨‹ç‰¹æ€§ï¼Œå¯ä»¥å»çœ‹ä¸€äº›JVMçš„ä¹¦ï¼ˆæ¯”å¦‚ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼‰ï¼Œé‡Œé¢æœ‰å…·ä½“çš„çº¿ç¨‹ç‰¹æ€§ã€‚ åˆ°äº†è¿™é‡Œå‘ç°ç®€å•è¯´ä¸‹çº¿ç¨‹ï¼Œä¼¼ä¹è¯´äº†å¥½å¤šï¼Œå¹¶æ²¡æœ‰æ”¶ä½ï¼Œè¿˜å°†ç»§ç»­è¯´ä¸‹å»ï¼Œå…¶å®è¿˜æ˜¯æƒ³å°½åŠ›è¯´çš„æ˜ç™½äº›ï¼Œå› ä¸ºä»ä¸ªäººçš„ç»éªŒæ¥çœ‹ï¼Œå¯¹çº¿ç¨‹çš„ç†è§£ç›´æ¥å†³å®šäº†å¯¹Handlerçš„ç†è§£ï¼Œæ‡‚çº¿ç¨‹çš„æ ¹æœ¬å°±ä¸ä¼šä¸æ‡‚Handlerï¼Œæ‡‚Handlerä¸æ‡‚çº¿ç¨‹çš„ï¼Œç»•äº†å‡ åœˆè¿˜æ˜¯ä¼šæ™•ã€‚è€Œä¸”ï¼Œæˆ‘ä»¥å‰åœ¨å­¦ä¹ Androidçš„æ—¶å€™ä¹Ÿè¢«å¥½å¤šä¸è´Ÿè´£ä»»çš„åšå®¢æŠ˜ç£¨çš„æ­»å»æ´»æ¥ã€‚æ‰€ä»¥æˆ‘æœ€è®¨åŒé‚£ç§ä¸Šæ¥å°±ç”©ä½ ä¸€è„¸å®šä¹‰ï¼Œä»£ç ï¼Œä¸“æœ‰åè¯ï¼Œä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿ï¼Œè€å­æ‡‚è¿™äº›çš„è¯è¿˜çœ‹ä½ åœ¨è¿™é€¼é€¼ï¼Ÿ æ‰¯è¿œäº†ï¼Œç»§ç»­è¯´çº¿ç¨‹ï¼Œåˆšåˆšè¯´çº¿ç¨‹å°±æ˜¯æ‰§è¡Œåºï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹å‘¢ï¼Ÿï¼ˆåœ¨Androidé‡Œä¸€èˆ¬ä¸»çº¿ç¨‹ï¼ŒUIçº¿ç¨‹ï¼Œmainçº¿ç¨‹éƒ½æ˜¯åœ¨è¯´ä¸€ä¸ªç©æ„ï¼šä¸»çº¿ç¨‹ï¼‰ã€‚ä¸»çº¿ç¨‹æ—¢ç„¶æ˜¯çº¿ç¨‹ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ‰§è¡Œåºï¼Œå®ƒä¹Ÿæ˜¯ç”±Javaæ¡†æ¶åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åæ‰§è¡Œå†™åœ¨å®ƒçš„ run() æ–¹æ³•è‚šå­é‡Œçš„ä»£ç ã€‚ç°åœ¨è¦æ³¨æ„äº†ï¼Œé‡ç‚¹æ¥äº†ï¼š å½“æˆ‘ä»¬ç‚¹å‡»æ¡Œé¢å›¾æ ‡ï¼Œæ¡Œé¢å®é™…ä¹Ÿæ˜¯ä¸€ä¸ªAPPï¼Œä¸Šé¢æ”¾å‡ ä¸ªViewï¼Œè¿™äº›Viewçš„Imageèµ„æºéƒ½æ˜¯æ¯ä¸ªAPPçš„å›¾æ ‡ï¼Œç‚¹å‡»åå°±å»æ‰§è¡Œçš„ä»£ç å°±æ˜¯newä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹çš„èµ„æºä»€ä¹ˆä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿æœ‰ä¸€å †æ˜¯æ ¹æ®ä½ åœ¨APPçš„Manifestæ–‡ä»¶é‡Œé¢é…ç½®ç”Ÿæˆçš„ã€‚è¿™ä¸€éƒ¨åˆ†åœ¨è¿™ä¸è®²ï¼Œåªéœ€è¦çŸ¥é“ï¼Œè¿›ç¨‹çš„å¿…ç„¶è¦æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹æ¥æ‰§è¡ŒAPPé‡Œé¢å†™çš„ä»£ç å§ã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬ä¸å»è£…é€¼çš„æ‹¿æºç å»è®²ä»€ä¹ˆç¬¬ä¸€ä¸ªActivityçš„å¯åŠ¨ï¼Œè¿˜æ˜¯æŒ‰ç…§ä¸Šé¢çš„ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå‡ºè¦æ‰§è¡Œ run() è‚šå­é‡Œçš„ä»£ç ã€‚å‡å¦‚æˆ‘ä»¬åœ¨é‡Œé¢å†™æ€æ ·å»åŠ è½½Viewï¼Œæ€æ ·å»ç»˜åˆ¶Viewï¼Œç„¶åå±•ç¤ºå‡ºæ¥ï¼Œå†ç„¶åå‘¢ï¼Œå½“Viewä¹Ÿç»˜åˆ¶å¥½äº†ï¼Œå±•ç¤ºå‡ºæ¥äº†ï¼Œç•Œé¢éƒ½å‘ˆç°å‡ºæ¥äº†ï¼Œè¿™æ—¶ä»£ç æ‰§è¡Œåºä¸å°±ç»“æŸäº†ä¹ˆï¼ŒæŒ‰é“ç†APPä¹Ÿå°±å…³æ‰äº†å•Šï¼Œä¸å¯èƒ½ç­‰åœ¨é‚£è®©æˆ‘ä»¬ç‚¹å‡»å•Šã€‚å…¶å®è¿™å°±æ˜¯å…³é”®äº†ï¼Œæˆ‘ä»¬è¦æƒ³è®©è¿™ä¸ªä¸»çº¿ç¨‹ä¸æ‰§è¡Œç»“æŸï¼Œä¸æ­»æ‰ï¼Œåº”è¯¥è¿˜æ˜¯å¾ˆå¥½è§£å†³çš„ã€‚æ¯”å¦‚ç›´æ¥åœ¨å‰é¢ä»£ç æ‰§è¡Œå®Œä»¥åï¼ŒViewæ˜¾ç¤ºå‡ºæ¥äº†ï¼Œè®©ä¸»çº¿ç¨‹å»æ‰§è¡Œä¸€ä¸ªWhlieï¼ˆtrueï¼‰çš„å¾ªç¯ï¼Œè¿™æ—¶ä¸å°±ä¸‡äº‹å¤§å‰äº†ä¹ˆã€‚Viewæ˜¾ç¤ºå‡ºæ¥ï¼Œä¸€ç›´æ˜¾ç¤ºç€ã€‚ ä½†æ˜¯è¿™æ ·è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸»çº¿ç¨‹ä¸€ç›´åœ¨whileå¾ªç¯é‡Œè·‘ï¼Œç”¨æˆ·æ— æ³•äº¤äº’ï¼Œä¸»çº¿ç¨‹ä¹Ÿæ— æ³•ç»§ç»­æ‰§è¡Œè¿™ä»£ç ã€‚å…¶å®è¿™æ—¶å€™æˆ‘ä»¬è‡ªå·±éƒ½èƒ½æƒ³åˆ°äº†ï¼Œè®©ä¸»çº¿ç¨‹è·‘åœ¨whileå¾ªç¯é‡Œï¼Œè®©ä»–æ¯æ¬¡å¾ªç¯éƒ½å»è®¿é—®æŸä¸ªåœ°æ–¹ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆäº‹è¦åšï¼Œæœ‰å°±æ‹¿æ¥åšäº†å†è·‘å¾ªç¯ï¼Œæ²¡æœ‰å°±ç»§ç»­è·‘å¾ªç¯ç›´åˆ°æœ‰äº‹æƒ…åšã€‚å…¶å®Androidæ•´ä¸ªUIæœºåˆ¶å°±æ˜¯è¿™æ ·çš„ï¼Œè£…é€¼ç‚¹è¯´å°±æ˜¯åŸºäºäº‹ä»¶çš„æœºåˆ¶ï¼ŒWindowså…¶å®ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚ ä¸»çº¿ç¨‹è·‘åœ¨ä¸€ä¸ªå¾ªç¯é‡Œé¢ï¼Œè€Œè¿™ä¸ªå¾ªç¯å°±æ˜¯Looperçš„ loop() æ–¹æ³•ã€‚æ˜¯æ—¶å€™è®©ä¸»è§’ä¹‹ä¸€ç™»åœºäº†ï¼š è¯´å®è¯Looperçš„æºç åŠ æ³¨é‡ŠçœŸçš„å†™çš„ç›¸å½“æ¸…æ¥šæ˜ç™½ï¼Œè€Œä¸”ä»£ç é‡æå°‘ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æœ€å‰é¢å…³äºLooperçš„æ³¨é‡Šï¼š /** * Class used to run a message loop for a thread. Threads by default do * not have a message loop associated with them; to create one, call * {@link #prepare} in the thread that is to run the loop, and then * {@link #loop} to have it process messages until the loop is stopped. * * &lt;p&gt;Most interaction with a message loop is through the * {@link Handler} class. * * &lt;p&gt;This is a typical example of the implementation of a Looper thread, * using the separation of {@link #prepare} and {@link #loop} to create an * initial Handler to communicate with the Looper. * * &lt;pre&gt; * class LooperThread extends Thread { * public Handler mHandler; * * public void run() { * Looper.prepare(); * * mHandler = new Handler() { * public void handleMessage(Message msg) { * // process incoming messages here * } * }; * * Looper.loop(); * } * }&lt;/pre&gt; */ æœ€å‰é¢å¾ˆæ˜¾çš„å†™ç€ï¼šLooperè¿™ä¸ªç±»ä¸€èˆ¬ç”¨äºè®©çº¿ç¨‹å»åšä¸€ä¸ªæ¶ˆæ¯çš„å¾ªç¯ï¼Œçº¿ç¨‹é‡Œé¢æœ¬æ¥æ˜¯æ²¡æœ‰ä¸€ä¸ªæ¶ˆæ¯å¾ªç¯å’Œçº¿ç¨‹ç›¸å…³è”çš„ã€‚å¦‚æœè¦åˆ›å»ºä¸€ä¸ªæœ‰loopå¾ªç¯çš„çº¿ç¨‹ï¼Œå°±è¦åœ¨çº¿ç¨‹çš„runæ–¹æ³•é‡Œå»è°ƒæ‰§è¡Œloopï¼Œè®©å®ƒåœ¨loopçš„è¿‡ç¨‹ä¸­å»å¤„ç†æ¶ˆæ¯ã€‚æ€ä¹ˆæ ·ï¼Œå’Œæˆ‘å‰é¢è®²çš„åŸºæœ¬ä¸€æ ·ï¼Œæˆ‘ä»¥å®‹å‰å‰çš„äººæ ¼å‘èª“ï¼Œæˆ‘ä¹‹å‰æ²¡ä»”ç»†çœ‹è¿‡è¿™æ®µæ³¨é‡Šï¼Œæœç„¶è‹±é›„æ‰€è§ç•¥åŒã€‚ç„¶åï¼Œæ³¨é‡Šåˆå†™äº†ä¸ªä¾‹å­ï¼Œæ•™ä½ æ€æ ·å†™ä¸€ä¸ªæœ‰Looperçš„çº¿ç¨‹ã€‚æŠ¬çœ¼ä¸€ç…ï¼Œè¿™ä¸å°±æ˜¯åœ¨runæ–¹æ³•çš„è‚šå­é‡Œæ‰§è¡Œ Looer.loop() ä¹ˆã€‚ã€‚ã€‚ æ ¹æ®æˆ‘ä»¬ä¸Šé¢è®²çš„çº¿ç¨‹çš„åŸç†ï¼Œå³ä½¿ä¸çœ‹è¿™ä¸ª loop() æ–¹æ³•ï¼Œå…ˆæ¥çŒœä¸€å‘ï¼Œçœ‹çœ‹å®ƒé‡Œé¢ä¼šæ€ä¹ˆå†™ï¼Œæ— éæ˜¯ä¸€ä¸ª whileï¼ˆture) å¾ªç¯ï¼Œç„¶ååœ¨é‡Œé¢æ¯æ¬¡æœ‰ä¸€ä¸ªå»æ¶ˆæ¯ï¼ŒæŠŠæ¶ˆæ¯é‡Œçš„ä»£ç æ‰§è¡Œçš„æ“ä½œï¼Œå¥½ï¼Œä¸Šæºç ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§è¯å¥‡è¿¹çš„æ—¶åˆ»ï¼š public static void loop() { final Looper me = myLooper(); if (me == null) { throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&apos;t called on this thread.&quot;); } final MessageQueue queue = me.mQueue; // Make sure the identity of this thread is that of the local process, // and keep track of what that identity token actually is. Binder.clearCallingIdentity(); final long ident = Binder.clearCallingIdentity(); for (;;) { Message msg = queue.next(); // might block if (msg == null) { // No message indicates that the message queue is quitting. return; } // This must be in a local variable, in case a UI event sets the logger Printer logging = me.mLogging; if (logging != null) { logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; + msg.callback + &quot;: &quot; + msg.what); } msg.target.dispatchMessage(msg); if (logging != null) { logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback); } // Make sure that during the course of dispatching the // identity of the thread wasn&apos;t corrupted. final long newIdent = Binder.clearCallingIdentity(); if (ident != newIdent) { Log.wtf(TAG, &quot;Thread identity changed from 0x&quot; + Long.toHexString(ident) + &quot; to 0x&quot; + Long.toHexString(newIdent) + &quot; while dispatching to &quot; + msg.target.getClass().getName() + &quot; &quot; + msg.callback + &quot; what=&quot; + msg.what); } msg.recycleUnchecked(); } } é¢é¢ï¼Œloop() æ–¹æ³•æ˜¯ã€‚ã€‚ã€‚æ—¥ï¼Œç«Ÿç„¶æ˜¯ä¸ª for(;;) ,å•ªå•ªï¼Œè¿™ä¸ªä¸ç®—æ‰“è„¸å§ï¼Œå’Œwhile(true) ä¸€æ ·å˜›ã€‚ç»§ç»­çœ‹forå¾ªç¯é‡Œé¢çš„ä»£ç ï¼š Message msg = queue.next(); è¿™è¡Œå°±æ˜¯ä»MessageQueueé‡Œé¢å–ä¸€ä¸ªMessageï¼Œä¹Ÿå°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œå–ä¸€ä¸ªæ¶ˆæ¯ã€‚å¦‚æœæ¶ˆæ¯æ˜¯nullï¼Œå°±ä¸¢å¼ƒæ‰ï¼Œç„¶åæ¥ä¸‹æ¥è‡ªç„¶ä¸å‡ºæˆ‘ä»¬æ‰€æ–™è¦å¤„ç†æ¶ˆæ¯äº†ï¼š msg.target.dispatchMessage(msg); è¿™è¡Œè‡ªç„¶å°±æ˜¯å¤„ç†æ¶ˆæ¯äº†ï¼Œè¿™é‡Œé¢ä¸ºä»€ä¹ˆè¿™æ ·å†™ä¹Ÿæ˜¯æœ‰æŠ€å·§çš„ï¼Œè®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼ˆè£…ä¸€ä¸‹é€¼ï¼‰ï¼šå› ä¸ºçº¿ç¨‹åœ¨æ‰§è¡Œ loop() çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“è¦åœ¨æ¯æ¬¡å¾ªç¯å»æ‰§è¡Œä»€ä¹ˆä»£ç ï¼Œæ‰€ä»¥åœ¨å®šä¹‰è¿™ä¸ªgoogleåœ¨å®šä¹‰è¿™ä¸ªæ¡†æ¶çš„æ—¶å€™ï¼Œå¿…é¡»ç•™ä¸€ä¸ªæ¥å£ï¼Œä»¥ä½ æ¥å†™ä»£ç ï¼Œæ¡†æ¶æ¥è°ƒç”¨çš„å½¢å¼å®šä¹‰ã€‚ä¸çœ‹æºç ä¸€åˆ‡éƒ½æ˜¯çé€¼é€¼ï¼Œç›´æ¥çœ‹æºç ï¼Œè¿™ä¸ªmsgæ˜¯ä¸€ä¸ªMessageå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¿™æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚Messageé‡Œæœ‰ä¸€ä¸ªå«targetçš„å±æ€§æ˜¯Handlerç±»å‹çš„ï¼š /*package*/ Handler target; åœ¨Handlerå‘é€è¿™ä¸ªæ¶ˆæ¯çš„æ—¶å€™ä¼šæŠŠHandlerä¼šæŠŠè‡ªå·±çš„å¼•ç”¨æ”¾åˆ°è¿™ä¸ªæ¶ˆæ¯çš„targetå±æ€§é‡Œ: public boolean sendMessageAtTime(Message msg, long uptimeMillis) { MessageQueue queue = mQueue; if (queue == null) { RuntimeException e = new RuntimeException( this + &quot; sendMessageAtTime() called with no mQueue&quot;); Log.w(&quot;Looper&quot;, e.getMessage(), e); return false; } return enqueueMessage(queue, msg, uptimeMillis); } private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) { msg.target = this; if (mAsynchronous) { msg.setAsynchronous(true); } return queue.enqueueMessage(msg, uptimeMillis); } æ‰€ä»¥æœ€ç»ˆloopå¾ªç¯å¦‚æœåœ¨æ¶ˆæ¯é˜Ÿåˆ—é‡Œå–åˆ°ä¸€ä¸ªæ¶ˆæ¯ï¼Œå°±å»æ‰§è¡Œå‘é€è¿™ä¸ªæ¶ˆæ¯çš„Handlerçš„ dispatchMessage(msg) æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å»çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œä»–ä¸€å®šä¼šé¢„ç•™ä¸€ä¸ªæ¥å£è®©æˆ‘å»å†™ä»£ç ï¼š public void dispatchMessage(Message msg) { if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); } } çœ‹åˆ°è¿™æœ€åè°ƒçš„è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åº”è¯¥å°±å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬å¹³æ—¶newä¸€ä¸ªHandlerä¸€èˆ¬éƒ½æ˜¯è¿™ä¸¤ç§æ–¹å¼å˜›ï¼š Handler handler = new Handler(new Handler.Callback() { @Override public boolean handleMessage(Message msg) { return false; } }); æˆ–è€… Handler handler = new Handler(){ @Override public void handleMessage(Message msg) { super.handleMessage(msg); } }; è¿™ä¸¤ç§æ–¹æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆé¸ŸåŒºåˆ«ï¼Œä¸€ä¸ªç”¨äº†æ¥å£ï¼Œéƒ½æ˜¯åœ¨ handleMessage(Message msg) æ–¹æ³•è‚šå­é‡Œå†™æˆ‘ä»¬è¦æ‰§è¡Œçš„ä»£ç ã€‚ å†å›åˆ°å‰é¢è¯´çš„ï¼Œçº¿ç¨‹åœ¨loopä¸­å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ï¼Œæ²¡æœ‰æ¶ˆæ¯å°±ç»§ç»­å¾ªç¯ï¼Œå–åˆ°æ¶ˆæ¯å°±æ‰§è¡Œæ‰§è¡Œå‘é€è¯¥æ¶ˆæ¯çš„Handlerçš„ dispatchMessage(Message msg) ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆæ‰§è¡Œçš„æ˜¯æˆ‘ä»¬å¡«å…¥ä»£ç çš„ handleMessage(Message msg) æ–¹æ³•ã€‚è¿™æ ·å°±å®ç°äº†é¢„ç•™å‡ºæ¥å£ï¼Œé€šè¿‡å¾ªç¯ï¼Œè®©ä¸»çº¿ç¨‹ä¸€ç›´å–æ¶ˆæ¯ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡å‘æ¶ˆæ¯åˆ°MessageQueueï¼Œå¹¶å†™å¥½æ”¶åˆ°æ¶ˆæ¯åè¦æ‰§è¡Œçš„æ“ä½œï¼Œè®©ä¸»çº¿ç¨‹æ¥è°ƒï¼Œç„¶ååœ¨å¾ªç¯è¿‡ç¨‹ä¸­æ‰§è¡Œä¸åŒçš„ä»£ç ï¼Œå®ç°äº¤äº’ã€‚ å…¶å®æ˜ç™½äº†ä¸»çº¿ç¨‹åœ¨loopå¾ªç¯çš„è¿‡ç¨‹ä¸­æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼ŒHandlerä¹Ÿå°±ç®€å•çš„ä¸€ç¬”äº†ï¼Œä½†æ˜¯å®ƒé‡Œé¢è¿˜æ˜¯æœ‰ä¸€äº›è®¾è®¡æ€æƒ³åœ¨é‡Œé¢ã€‚æˆ‘å‡†å¤‡å¤šå†™å‡ ç¯‡ï¼Œå…·ä½“åˆ°æ¯è¡Œä»£ç ï¼ŒæŠŠMessageQueueï¼ŒMessageï¼ŒHandlerçš„æºç éƒ½æ‹¿è¿‡æ¥æ™’æ™’ï¼Œç„¶åç†è§£æ¯ä¸€è¡Œä»£ç çš„ä½œç”¨ã€‚è™½ç„¶å¯èƒ½å¼€å‘ä¸­ä½¿ç”¨ä¸éœ€è¦è¿™ä¹ˆç»†è‡´çš„ç†è§£ï¼Œä½†æ˜¯Androidæºç é‡Œé¢çš„è®¾è®¡æ€æƒ³è¿˜æ˜¯æœ‰å¾ˆå¤šå€¼å¾—å€Ÿé‰´çš„åœ°æ–¹ï¼Œçœ‹ç€è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚ å¦‚æœåœ¨è¿™ç¯‡æœ‰æ²¡æœ‰çœ‹æ‡‚çš„åœ°æ–¹ä¹Ÿä¸ç”¨ç€æ€¥ï¼Œå› ä¸ºåé¢ä¼šæ›´ç»†è‡´çš„æŠŠæ•´ä¸ªæ¶‰åŠçš„çŸ¥è¯†è®²å®Œã€‚ ï¼ˆæœ¬ç¯‡å®Œï¼Œä¸‹ç¯‡å¾…ç»­ï¼‰","tags":[{"name":"Android","slug":"Android","permalink":"http://yoursite.com/tags/Android/"}]},{"title":"ä»æ¢¦æƒ³åˆ°æ¢¦é†’","date":"2016-12-16T11:43:52.000Z","path":"2016/12/16/ä»æ¢¦æƒ³åˆ°æ¢¦é†’/","text":"ä¸€ç›´æƒ³å¼„è‡ªå·±çš„åšå®¢ï¼Œå´ä¸€ç›´æ²¡æœ‰çœŸæ­£åŠ¨æ‰‹å»åšï¼Œä¸€ä¸ªæ˜¯è§‰ç€è‡ªå·±å¹³æ—¶è¿CSDNéƒ½æ²¡æ—¶é—´å»æ€»ç»“ï¼Œå†å¼„ä¸ªåšå®¢ï¼Œå†™äº›ä¹±ä¸ƒå…«ç³Ÿçš„æ€»æœ‰ä¸ºèµ‹æ–°è¯å¼ºè¯´æ„çš„æ„Ÿè§‰ã€‚å¦ä¸€ä¸ªæ˜¯ä¹Ÿç¡®å®è¢«å„ç§å„æ ·çš„äº‹æƒ…å æ®ç€ï¼Œé™ä¸ä¸‹å¿ƒï¼Œä¹Ÿè…¾ä¸å‡ºæ‰‹ã€‚æœ€è¿‘å·¥ä½œåˆå®šï¼Œæ˜¯æ—¶å€™ç»™è‡ªå·±æ€»ç»“ä¸‹äº†ã€‚ï¼ˆç»“æœå‘ç°åœ¨githubä¸Šå¼„ä¸€ä¸ªè‡ªå·±çš„åšå®¢å‡ºå¥‡çš„ç®€å•ï¼‰ ä¸€ä¸ªäººä»å¹¿å·è·‘åˆ°å¸éƒ½ï¼Œè€ƒç ”èƒ¡é—¹å‡†å¤‡äº†å‡ ä¸ªæœˆï¼Œç»ˆç©¶ä½œç½¢ï¼Œç»å†äº†æ‹–æ‹–æ‹‰æ‹‰çš„æ‰¾å·¥ä½œçš„è¿‡ç¨‹ï¼Œæ€»ç®—ä¸€åˆ‡å®‰å®šä¸‹æ¥äº†ã€‚åœ¨æ­¤ç®—æ˜¯æ¢³ç†ä¸‹è‡ªå·±çš„æ€ç»ªï¼Œä¸ºä»¥ååšäº›è§„åˆ’ï¼Œä¹Ÿç®—æ˜¯èµ°èµ°åœåœï¼Œç»™è‡ªå·±ç•™ä¸‹ç‚¹çºªå¿µã€‚æ¯•ç«Ÿä¸­äºŒç—…ä¸€ç›´ç—…åˆ°ç°åœ¨æ²¡å¥½ï¼Œè¿˜æ˜¯è¦ç•™ä¸€ä¸ªçª—å£ï¼Œå¯ä»¥ç»™è‡ªå·±æ€»ç»“ï¼Œè§„åˆ’ï¼Œæ— è®ºæ˜¯æŠ€æœ¯ä¸Šçš„ï¼Œç”Ÿæ´»ä¸Šçš„ï¼Œè¿˜æ˜¯å…³äºé‚£é£˜å¿½ä¸å®šçš„ç²¾ç¥ä¸Šçš„ã€‚ å›å¤´æƒ³æƒ³ï¼Œæ„Ÿè§‰å¾ˆå¤šäº‹æƒ…éƒ½è¯´ä¸ä¸Šç®—æ˜¯å¾—è¿˜æ˜¯å¤±ã€‚åœ¨å¤§ä¸‰æš‘å‡çš„æ—¶å€™ï¼Œæˆ‘è¿˜å¯¹Androidä¸€æ— æ‰€çŸ¥ï¼Œç„¶åç¨€é‡Œç³Šæ¶‚çš„å­¦Javaï¼Œå½“æ—¶çš„ç›®çš„å¾ˆå•çº¯ï¼Œå°±æ˜¯æƒ³æ‰¾ä¸ªå·¥ä½œï¼Œå¯¹è‡ªå·±çš„å®šä½å°±æ˜¯ï¼šä¸€æ— æ˜¯å¤„ï¼Œä¸€æ— æ‰€æœ‰ï¼Œä¸€æ— æ‰€çŸ¥ã€‚åæ¥ç¨€é‡Œç³Šæ¶‚çš„å°±è¿‡äº†YYçš„é¢è¯•ï¼Œç„¶åæ‹¿åˆ°ä¸€ä¸ªç›¸å¯¹è¿˜å¯ä»¥çš„offerï¼Œä¸€ä¸ªè¿Viewæ˜¯ä»€ä¹ˆéƒ½ä¸çŸ¥é“çš„äººæ‹¿åˆ°äº†YY Androidå¼€å‘å·¥ç¨‹å¸ˆçš„Offerï¼Œå°±è¿™æ ·è†¨èƒ€è€Œåˆå¿ƒè™šçš„å¼€å§‹äº†æµªå®Œäº†è‡ªå·±çš„å¤§å››ã€‚å½“æ—¶ä»¥ä¸ºçš„å¥½äº‹ï¼Œç°åœ¨å›å¤´çœ‹å´è§‰å¾—åˆæ˜¯å¦å¤–ä¸€å›äº‹ã€‚ ç”±äºè‡ªå·±çš„æ‡µæ‡‚æ— çŸ¥ï¼Œå¯¹Androidçš„è®¤çŸ¥ä»…é™äºå¦‚æœæˆ‘å­¦å®Œç¬¬ä¸€è¡Œä»£ç ä¸€å®šå¾ˆç‰›é€¼ã€‚å·¥ä½œå¹¶ä¸åƒè‡ªå·±æƒ³è±¡çš„é‚£æ ·ï¼Œç»™ä½ ä¸‰ä¸ªæœˆå‡†å¤‡æ—¶é—´æ¥å­¦ä¹ ã€‚ä¸Šå²—å°±å¼€å§‹äº†ç—›è‹¦çš„æŒ£æ‰ï¼Œä¸€ä¸ªå¯¹Androidä¸€ç‚¹éƒ½ä¸æ‡‚çš„äººä¸Šæ¥å°±å¼€å§‹å„ç§æäº†ï¼Œåœ†è§’å›¾ç‰‡æ‹¿åˆ°bitmapæœåˆ°ä¸ªç®—æ³•å°±ç›´æ¥å¼€å§‹è®¡ç®—ï¼Œç”¨SharedPreferenceå­˜èµ·æ¥ï¼Œä»£ç ä¸­å„ç§ç©ºæŒ‡é’ˆCrashï¼Œä¸çŸ¥é“ä»€ä¹ˆæ˜¯Jsonã€‚å°±è¿™æ ·ç»å†äº†å¤§æ¦‚ä¸€ä¸ªæœˆï¼Œç„¶åå¼€å§‹å¯¹Androidä¸€ç›´åŠè§£ã€‚ç„¶åæˆ‘ä»¬é¡¹ç›®åˆæ˜¯é‚£ç§äº§å“ç»ç†ç©å‘½å‚¬ï¼Œå¼€å‘ç–¯ç‹‚åŠ ç­çš„èŠ‚å¥ï¼Œæˆ‘çš„ç¬¬ä¸€ä»½å·¥ä½œï¼Œå‰ä¸‰ä¸ªæœˆï¼Œå…¬å¸æ‰“å¡è®°å½•ä¸Šå‡ ä¹æ²¡æœ‰ä¸€å¤©ç¼ºè¿‡æˆ‘ã€‚å½“ç„¶ä¹Ÿæœ‰å‘¨æœ«å»å…¬å¸æ‰“æ¸¸æˆï¼Œå¿ƒé‡Œå…¶å®å¼‚å¸¸å‹æŠ‘å’Œè‹¦é—·çš„æƒ…å†µã€‚ åœ¨YYçš„ç»å†ä¸€ç›´éƒ½æ˜¯æ„Ÿè§‰ç‰¹åˆ«å‹æŠ‘å’Œè‹¦é—·çš„ã€‚åæ¥å›å¤´æƒ³æƒ³ï¼Œå…¶å®å¹¶ä¸èƒ½æ€ªä»»ä½•äººï¼Œä¹Ÿä¸æ˜¯å…¬å¸çš„é—®é¢˜ï¼ˆå½“æ—¶åŒ…æ‹¬ç°åœ¨å¿ƒé‡Œéƒ½è¿˜æ„Ÿæ¿€ç€åœ¨YYé‡åˆ°çš„å¥½å¤šäººï¼Œä¸ç»†è¯´äº†ï¼Œæ”¾å¿ƒé‡Œæœ€å¥½ï¼‰ï¼Œä¸»è¦è¿˜æ˜¯è‡ªå·±çš„åŸå› ã€‚ä»¥è‡³äºæˆ‘æ¯æ¬¡çœ‹åˆ°éœ€æ±‚ï¼Œå¿ƒæƒ…éƒ½æ˜¯æ²‰é‡çš„ã€‚æ€»æ˜¯çœ‹ä»€ä¹ˆéƒ½å…ˆçœ‹è‡ªå·±å“ªäº›ä¸ä¼šï¼Œå“ªäº›è‡ªå·±è¿˜æ²¡æœ‰æŒæ¡ï¼Œå¿ƒé‡Œæš—æš—å‘è™šã€‚æ¯å¤©å°±è¿™æ ·æ­»æ’‘ç€ï¼Œä¾ç„¶æ²¡æœ‰ä»€ä¹ˆè¿›æ­¥ã€‚è¿™æ ·çš„æ—¥å­å¯ä»¥æƒ³è€ŒçŸ¥ï¼Œä»¥æˆ‘ç‹‚æ”¾ä¸ç¾ï¼ˆåƒä¸äº†è‹¦ï¼‰çš„æ€§æ ¼è‡ªç„¶å¾…ä¸ä¹…äº†ã€‚ å½“ä¸€ä¸ªäººæŠŠè‡ªå·±éƒ½éª—è¿‡äº†ä¹‹åï¼Œå°±å†ä¹Ÿæ²¡æœ‰ä»€ä¹ˆèƒ½é˜»æŒ¡ä»–ä¸­äºŒçš„èŠ‚å¥äº†ã€‚äºæ˜¯æˆ‘å¼€å§‹äº†è’å”çš„è€ƒç ”ã€‚è¿‡ç¨‹å°±ä¸è¡¨äº†ï¼Œè¯´å¤šäº†éƒ½æ˜¯çœ¼æ³ªã€‚ æˆ‘ä¼¼ä¹æ˜¯ä¸€ä¸ªä»€ä¹ˆäº‹éƒ½éœ€è¦åå¤å’€åš¼çš„äººï¼Œå½“æˆ‘ç¦»èŒä»¥åï¼Œè€ƒç ”ï¼ˆä¿®èº«å…»æ€§ï¼‰çš„è¿‡ç¨‹ä¸­çªç„¶å‘ç°ï¼ŒåŸæ¥é‚£äº›æŠŠè‡ªå·±æŠ˜ç£¨çš„æ­»å»æ´»æ¥çš„ä¸œè¥¿ç«Ÿç„¶æ˜¯é‚£ä¹ˆç®€å•ã€‚è·³å‡ºæ¯å¤©æ­»æ’‘ç€ä¸Šç­çš„æ€ªåœˆåè‡ªå·±çªç„¶æˆé•¿äº†ï¼Œå¯¹Androidçš„ç†è§£ä¹Ÿæ›´æ·±åˆ»äº†ã€‚æœ‰å¥½å¤šä¸œè¥¿è«åå…¶å¦™å›æƒ³èµ·æ¥çš„æ—¶å€™çªç„¶å°±æ˜ç™½äº†ï¼ŒæœŸé—´è‡ªå·±ä¹Ÿè®¤çœŸçœ‹äº†æ“ä½œç³»ç»Ÿï¼Œä¸€ç›´è§‰çš„æ“ä½œç³»ç»Ÿæ˜¯æœ€ç¾ï¼Œæœ€å¸å¼•äººçš„ä¸€ä¸ªä¸œè¥¿ã€‚ä»¥åæœ‰æ—¶é—´è¿˜è¦æ‹¿å‡ºæ¥å“å‘³ä¸€ç•ªã€‚ è’å”çš„è€ƒç ”æ²¡ç»“æŸï¼Œå°±å¼€å§‹äº†æ‹–æ‹–æ‹‰æ‹‰çš„æ‰¾å·¥ä½œï¼Œæ¯å¤©ç¡åˆ°ä¸‹åˆï¼Œé¢è¯•ä¹Ÿä¸æƒ³å»ï¼Œä¹¦ä¹Ÿä¸æƒ³çœ‹ï¼Œæ¯å¤©å°±æ˜¯è§‰å¾—è‡ªå·±å¾ˆç´¯ï¼Œå…¶å®å•¥ä¹Ÿæ²¡åšã€‚ ç»ˆäºç¨€é‡Œç³Šæ¶‚æ‰¾äº†ä¸€ä»½å·¥ä½œï¼Œæ¯å¤©æ—¥å­ä¸å†é‚£ä¹ˆç´§è¿«ï¼Œä¸Šä¸‹ç­è·¯ä¸Šéƒ½èƒ½çœ‹çœ‹åšå®¢ï¼Œå·¥ä½œæ—¶è¿˜èƒ½æç‚¹æ–°ä¸œè¥¿ï¼Œæ¯å¤©è¿‡çš„è¿˜æŒºå……å®çš„ã€‚æ€»è§‰å¾—ç°åœ¨æˆ–è®¸æ˜¯è‡ªå·±ä¸Šå¤§å­¦ä»¥æ¥è¿‡çš„æœ€è¸å®çš„ä¸€æ®µæ—¥å­ï¼Œæ¯å¤©çŸ¥é“è¦å¹²ä»€ä¹ˆï¼Œè™½ç„¶æœ‰æ—¶å€™å¾ˆå¿™ï¼Œæœ‰æ—¶å€™å› ä¸ºä¸€ä¸ªé—®é¢˜å¡ä½ï¼Œå¡çš„å¾ˆç—›è‹¦ï¼Œä½†å¿ƒé‡Œå†ä¹Ÿä¸ä¼šæ„Ÿåˆ°å‹æŠ‘æˆ–è€…æ„Ÿåˆ°æ²¡æœ‰ä¿¡å¿ƒã€‚å…¶å®æƒ³æ˜ç™½äº†ï¼Œå½“ä½ è‡ªå·±çœ‹å¼€çš„æ—¶å€™ï¼Œæ²¡æœ‰ä»»ä½•äººèƒ½æ‹¿ä½ æ€ä¹ˆæ ·ã€‚æ¯å¤©æœ‰åƒæœ‰å–ï¼Œç„¶åå­¦è‡ªå·±æƒ³å­¦çš„ï¼Œçœ‹è‡ªå·±æƒ³çœ‹çš„ï¼ŒåŒæ—¶åšå¥½è‡ªå·±çš„æœ¬èŒå·¥ä½œï¼Œå°½åŠ›ä¸ºå…¬å¸å¸¦æ¥ä»·å€¼ï¼Œè¿™ä¾¿è¶³å¤Ÿã€‚ å…¶å®ä¸€ç›´æƒ³å†™ç‚¹æŠ€æœ¯ç±»çš„ä¸œè¥¿æ¥ç€ï¼Œæ¯”å¦‚æœ€è¿‘åšäº†OkHttpçš„å°è£…ï¼Œä¹Ÿè£…é€¼ç”¨äº†ä¸€æŠŠMVPï¼Œç”¨äº†RxJavaï¼Œå¯¹Glideäº†è§£äº†ä¸€äº›ï¼Œä½†æ€»è§‰çš„ä¸æƒ³å†™åˆ«äººå†™è¿‡çš„ä¸œè¥¿ï¼Œåˆ«äººæ²¡å†™è¿‡çš„ï¼Œåˆæ²¡æœ‰å¤§æŠŠçš„æ—¶é—´æ¥ç ”ç©¶ï¼Œåªèƒ½è¾¹å­¦è¾¹çœ‹äº†ã€‚ä¸è¿‡ä¹Ÿç®—ä¸Šè·¯äº†ï¼Œä¸å†å¯¹ä»€ä¹ˆæŠ€æœ¯äº§ç”Ÿé«˜å¤§ä¸Šçš„ç•æƒ§å¿ƒç†ï¼Œæˆ‘è§‰å¾—è¿™ä¾¿æ˜¯æœ€å¤§çš„è¿›æ­¥å§ã€‚ã€‚ã€‚ï¼ˆå®Œï¼‰","tags":[{"name":"æ¯’è¯","slug":"æ¯’è¯","permalink":"http://yoursite.com/tags/æ¯’è¯/"}]}]